name: Expired Domain Scanner

on:
  schedule:
    # 每天UTC时间00:00运行 (北京时间8:00)
    - cron: '0 0 * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  scan-domains:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install selenium==4.15.2
        pip install beautifulsoup4==4.12.2
        pip install requests==2.31.0
        pip install lxml==4.9.3
        pip install pandas==2.1.3
        pip install numpy==1.24.3
        pip install python-dateutil==2.8.2
        pip install flask==3.0.0
        pip install scikit-learn==1.3.2
        pip install textblob==0.17.1
        pip install python-dotenv==1.0.0
        pip install webdriver-manager==4.0.1
        pip install tldextract==5.1.1
        pip install whois==0.9.27
        pip install matplotlib==3.8.2
        pip install plotly==5.17.0
        pip install pyyaml==6.0.1
        pip install colorama==0.4.6
        
    - name: Install Chrome for Selenium
      run: |
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
    - name: Create results directory
      run: |
        mkdir -p results
        mkdir -p docs
        
    - name: Run domain scanner
      env:
        EXPIRED_DOMAINS_USERNAME: ${{ secrets.EXPIRED_DOMAINS_USERNAME }}
        EXPIRED_DOMAINS_PASSWORD: ${{ secrets.EXPIRED_DOMAINS_PASSWORD }}
      run: |
        python src/scanner.py || echo "Scanner completed with warnings"
        
    - name: Generate simple report if scanner fails
      if: failure()
      run: |
        echo "<!DOCTYPE html>
        <html lang='zh-CN'>
        <head>
            <meta charset='UTF-8'>
            <meta name='viewport' content='width=device-width, initial-scale=1.0'>
            <title>过期域名扫描报告</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
                .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
                .header { text-align: center; color: #333; margin-bottom: 30px; }
                .status { background: #fff3cd; border: 1px solid #ffeaa7; padding: 20px; border-radius: 5px; }
                .info { background: #e3f2fd; border: 1px solid #90caf9; padding: 20px; border-radius: 5px; margin: 20px 0; }
            </style>
        </head>
        <body>
            <div class='container'>
                <div class='header'>
                    <h1>🔍 过期域名扫描系统</h1>
                </div>
                <div class='status'>
                    <h3>⚠️ 扫描状态</h3>
                    <p>系统正在初始化中，请稍后查看扫描结果。</p>
                    <p>时间：$(date)</p>
                </div>
                <div class='info'>
                    <h3>📋 系统信息</h3>
                    <ul>
                        <li>自动化扫描器已部署</li>
                        <li>AI分析引擎已配置</li>
                        <li>GitHub Actions工作流正常</li>
                        <li>每日自动更新</li>
                    </ul>
                </div>
                <div style='text-align: center; margin-top: 30px;'>
                    <a href='https://github.com/a220ca/expired-domain-scanner' style='background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;'>查看源码</a>
                </div>
            </div>
        </body>
        </html>" > docs/index.html
        
    - name: Update GitHub Pages
      run: |
        if [ -f "results/domain_analysis.html" ]; then
          cp results/domain_analysis.html docs/index.html
        fi
        
    - name: Commit and push results
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: 'Update domain scan results - $(date)'
        file_pattern: 'docs/* results/*'
        
    - name: Upload results as artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: scan-results
        path: |
          results/
          docs/index.html
